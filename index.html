const fileInput = document.getElementById('fileInput');
const previewGrid = document.getElementById('previewGrid');
const downloadAll = document.getElementById('downloadAll');
const outlineWidthInput = document.getElementById('outlineWidth');
const outlineColorInput = document.getElementById('outlineColor');
const edgeSmoothingInput = document.getElementById('edgeSmoothing');

let items = [];

fileInput.addEventListener('change', () => {
  items = [];
  previewGrid.innerHTML = '';

  Array.from(fileInput.files).forEach(file => {
    const reader = new FileReader();
    reader.onload = () => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        renderOutline(img, canvas);
        items.push({ name: file.name.replace(/\.[^/.]+$/, ''), canvas });

        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        wrap.appendChild(canvas);
        previewGrid.appendChild(wrap);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
});

[outlineWidthInput, outlineColorInput, edgeSmoothingInput].forEach(el => {
  el.addEventListener('input', () => {
    items.forEach(item => {
      const img = new Image();
      img.src = item.canvas.toDataURL(); // recreate image from canvas
      img.onload = () => renderOutline(img, item.canvas);
    });
  });
});

function renderOutline(img, canvas) {
  const width = parseInt(outlineWidthInput.value, 10);
  const color = outlineColorInput.value;
  const smooth = edgeSmoothingInput.checked;
  const pad = width + 2;

  canvas.width = img.width + pad * 2;
  canvas.height = img.height + pad * 2;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Draw outline using shadow trick (much faster than pixel loop)
  ctx.save();
  ctx.shadowColor = color;
  ctx.shadowBlur = width;
  ctx.drawImage(img, pad, pad);
  ctx.restore();

  // Optional smoothing
  if (smooth) ctx.filter = 'blur(1.25px)';

  ctx.drawImage(img, pad, pad);
  ctx.filter = 'none';
}

downloadAll.addEventListener('click', async () => {
  if (!items.length) return;

  const zip = new JSZip();
  items.forEach(item => {
    const data = item.canvas.toDataURL('image/png').split(',')[1];
    zip.file(item.name + '_outlined.png', data, { base64: true });
  });

  const blob = await zip.generateAsync({ type: 'blob' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'outlined_images.zip';
  document.body.appendChild(a);
  a.click();
  a.remove();
});
